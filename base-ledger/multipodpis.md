---
description: k-of-n multisignature
---

# Мультиподпись

Предикат достоверности k-of-n multisignature авторизует транзакции на основании того, что их одобрили k из n сторон. Данный документ предназначен для зашифрованных (внутренних) транзакций WASM. Namada не поддерживает множественные подписи на wrapper-транзакциях или транзакциях протокола. Подписант wrapper-транзакции является плательщиком комиссии за эту транзакцию.

### Протокол&#x20;

Транзакции Namada подписываются перед передачей в сеть. Эта подпись проверяется вызываемыми предикатами валидности для определения достоверности транзакции. Для поддержки мультиподписи данные подписанной транзакции Namada включают в себя открытый текст подписываемой информации, а также все действительные подписи над этой информацией.

Не существует специальных учетных записей с мультиподписью - все учетные записи пользователей являются просто 1 к 1 мультиподписными учетными записями.

#### Rust-реализация&#x20;

Ниже описана rust-реализация структуры `SignedTxData`:

```rust
pub struct SignedTxData {
    /// The original tx data bytes, if any
    pub data: Option<Vec<u8>>,
    /// The signature is produced on the tx data concatenated with the tx code
    /// and the timestamp.
    pub sig: Vec<(u8, common::Signature)>,
}
```

Поле `sig` содержит вектор кортежей, первый элемент которого представляет собой 8-битное целое число, а второй - подпись. Целое число служит индексом для сопоставления конкретной подписи с одним из открытых ключей в списке принятых для повышения эффективности. Такая реализация позволяет улучшить алгоритм верификации, снизив сложность выполнения до Q(n), без необходимости циклического перебора всех ключей, что было бы Q(n в квадрате).

### VP

Все учетные записи пользователей-владельцев используют для проверки изменений состояния предикат достоверности `vp_user`, используемый по умолчанию. Предикат достоверности `vp_user` утверждает, что для каждой транзакции, исходящей от пользователя, в подписанных данных транзакции присутствует не менее `k` из `n` достоверных подписей.

Для выполнения проверки достоверности VP требует две части информации:

1. Порог мультиподписи.
2. Список открытых ключей действительных подписантов.&#x20;

Эти данные определяют требования к валидной транзакции, работающей по мультиподписному адресу, и записываются в память при создании счета.

Ниже показана реализация хранилища в виде RUST:

```rust
/$Address/threshold/: u8
/$Address/pubkeys/: LazyVec<PublicKey>
```

Для проверки корректности подписей VP проверяет следующие условия:

1. Обеспечено достаточное количество уникальных подписей для заданного порога
2. Достаточное количество достоверных подписей для заданного порога.&#x20;

Такая реализация позволяет повысить эффективность работы: Шаг 1 позволяет сократить процесс проверки и избежать лишней обработки и обращения к хранилищу. Каждая подпись проверяется только по открытому ключу, найденному в списке по заданному индексу. Шаг 2 останавливается, как только будет получено достаточное количество валидных подписей, соответствующих пороговому значению, то есть оставшиеся подписи не подвергаются ненужной проверке.

### Адреса&#x20;

Представленный в предыдущем разделе vp доступен для всех установленных адресов на Namada. Если пользователь хочет инициализировать установленный адрес как мультиподписной, он должен указать порог мультиподписи и действительные подписи. По умолчанию порог устанавливается равным 1, если он не указан. Для проверки VP должен быть предоставлен хотя бы один ключ в качестве действительного ключа подписи.

После выполнения этой транзакции выполняются следующие записи в хранилище в ассоциации, в подпространстве хранения данного пользователя:

1. Адрес `vp_user`&#x20;
2. Порог счета мультиподписи&#x20;
3. Список открытых ключей подписывающих лиц мультиподписного счета.&#x20;

Мультиподписные счета могут инициализироваться и в момент генезиса - в этом случае необходимые параметры хранятся в файле генезиса и записываются в хранилище при инициализации.

### Проверка инициализации учетной записи Multisig

Поскольку при создании счета не срабатывает VP установленного счета, то не будет выполняться проверка параметров мультиподписи, а значит, создатель может указать неверные данные.

Для выполнения проверки при создании счета Namada может:

1. Записать в хранилище адреса вместе с открытыми ключами для запуска их VP&#x20;
2. Вручную запускать мультисиг VP даже в момент создания счета&#x20;
3. Создать внутренний VP, управляющий созданием каждой учетной записи с мультиподписью.&#x20;

Все эти решения предполагают, что транзакция инициации станет мультиподписной.

В решении 1 на самом деле есть проблема: если участники счета захотят исключить одного из них из состава счета, то целевой счет может отказаться подписывать multisig-транзакцию с этой модификацией. В момент валидации сработает его закрытый VP, и, поскольку в транзакции нет подписи, соответствующей его открытому ключу, он отклонит ее, фактически не позволив мультисиг-счету работать даже при наличии достаточного количества подписей, чтобы соответствовать порогу. Это противоречит принципу, согласно которому мультисигма-счет должен быть самодостаточным и управляться собственным VP, а не VP его участников.

В решении 2 проверка будет лишь частичной, поскольку логика VP будет вращаться вокруг порога.

Наконец, решение 3 требует наличия внутреннего VP, предназначенного для управления параметрами мультисиговых адресов как при создании, так и при модификации. В нем может быть реализована логика, основанная на пороге, или логика, требующая подписи всех членов для инициализации/изменения параметров мультиподписного счета. Первый вариант фактически сводится к VP самой учетной записи (делая внутренний VP избыточным), а второй имеет ту же проблему, что и решение 1.

В итоге мы не будем реализовывать ни одну из этих проверок и возложим ответственность на подписанта транзакции, создающей адрес: в случае ошибки он может просто подать новую транзакцию для генерации корректного счета. С другой стороны, участники мультисигового счета могут отказаться от подписания транзакций, если они не согласны с параметрами, определяющими сам счет.

### Построение транзакции&#x20;

Для того чтобы создать транзакцию с несколькими подписями, необходимо скоординировать действия участников. Точнее, сама транзакция строится одним субъектом, который рассылает ее другим подписантам и собирает их подписи.

{% hint style="info" %}
<mark style="color:blue;">Обратите внимание, что сторона, создающая транзакцию, не обязательно должна быть одной из подписавших ее лиц.</mark>
{% endhint %}

Наконец, эти подписи вставляются в структуру `SignedTxData` для шифрования, обертывания и передачи в сеть.

В Namada не предусмотрен слой для поддержки этого процесса, поэтому участвующим сторонам придется полагаться на внешний механизм связи.
